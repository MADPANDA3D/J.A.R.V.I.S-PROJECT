# Story 007.001: User Bug Report Interface and Database Schema

## Status
üîç **Ready for Review**

## Story
**As a** JARVIS Chat user,  
**I want** a user-friendly bug reporting interface that connects to structured database storage,  
**so that** I can easily submit detailed bug reports that are properly stored and linked to existing error tracking data for effective resolution.

## Acceptance Criteria

1. **User Bug Report Interface**: Create intuitive bug submission form with fields for title, description, bug type, severity, reproduction steps, and browser information that integrades seamlessly with existing UI patterns
2. **Supabase Database Schema**: Implement comprehensive database schema including bug_reports, bug_comments, and bug_attachments tables with proper relationships and indexes for efficient querying
3. **Error Tracking Integration**: Connect new bug reporting system with existing sophisticated error tracking infrastructure (errorTracking.ts, advancedErrorTracking.ts) to automatically include technical error data
4. **Form Validation and UX**: Implement robust form validation, user feedback, file attachment support, and progressive enhancement that maintains accessibility and follows existing design patterns
5. **Real-Time Integration**: Ensure bug submission integrates with existing monitoring systems and provides immediate confirmation to users while preserving all current error handling functionality

## Tasks / Subtasks

- [ ] **Task 1: Supabase Database Schema Implementation** (AC: 2)
  - [ ] Create `bug_reports` table with comprehensive fields for bug tracking and user information
  - [ ] Design `bug_comments` table for internal notes and user communication with proper threading
  - [ ] Implement `bug_attachments` table for file uploads with secure storage and access controls
  - [ ] Set up proper table relationships, indexes, and Row Level Security (RLS) policies for data protection

- [ ] **Task 2: User Bug Report Form Component** (AC: 1, 4)
  - [ ] Create `BugReportForm.tsx` component following existing design patterns and accessibility standards
  - [ ] Implement form fields for title, description, bug type selection, severity rating, and reproduction steps
  - [ ] Add browser information auto-collection and user environment detection
  - [ ] Create file attachment interface with drag-drop support and format validation

- [ ] **Task 3: Error Tracking System Integration** (AC: 3)
  - [ ] Integrate with existing `errorTracking.ts` to automatically include recent error data in bug reports
  - [ ] Connect with `advancedErrorTracking.ts` for pattern detection and error context enhancement
  - [ ] Link bug reports to runtime error monitor data for comprehensive technical information
  - [ ] Ensure ErrorBoundary integration for capturing React component errors with bug reports

- [ ] **Task 4: Form Validation and User Experience** (AC: 4)
  - [ ] Implement comprehensive form validation using Zod schemas consistent with existing patterns
  - [ ] Add real-time validation feedback and user-friendly error messages
  - [ ] Create auto-save functionality to prevent data loss during form completion
  - [ ] Implement accessibility features including screen reader support and keyboard navigation

- [ ] **Task 5: Bug Submission Processing and Storage** (AC: 2, 5)
  - [ ] Create bug submission service with proper error handling and retry logic
  - [ ] Implement secure file upload processing with virus scanning and size limits
  - [ ] Add bug report deduplication logic to prevent spam and duplicate submissions
  - [ ] Create immediate user feedback system with confirmation and tracking number generation

- [ ] **Task 6: Integration Testing and Monitoring Enhancement** (AC: 3, 5)
  - [ ] Test integration with existing monitoring.ts system and external services (Sentry, DataDog)
  - [ ] Validate that existing error tracking functionality remains intact and enhanced
  - [ ] Test bug report submission under various error conditions and network scenarios
  - [ ] Verify real-time monitoring integration and alert system functionality

## Dev Notes

### Epic 007 Context

**Sophisticated Foundation**: This story builds on existing world-class error tracking infrastructure including `errorTracking.ts`, `advancedErrorTracking.ts`, `RuntimeErrorMonitor.tsx`, `ErrorBoundary.tsx`, and `monitoring.ts` to add user-facing bug reporting capabilities.

**Critical Gap Resolution**: Addresses the missing user bug report interface identified by James's analysis while preserving and enhancing the existing sophisticated technical error infrastructure.

### Technical Context

**Existing Error Infrastructure** [Source: epic-007-user-facing-bug-reporting-system.md]:
- **Advanced Error Tracking**: `errorTracking.ts` & `advancedErrorTracking.ts` with in-memory storage, pattern detection, and real-time alerting
- **Runtime Error Monitor**: `RuntimeErrorMonitor.tsx` with real-time JavaScript error monitoring and stack trace analysis
- **Error Boundaries**: Professional `ErrorBoundary.tsx` with user-friendly fallback UI and recovery options
- **APM Monitoring**: `monitoring.ts` with Core Web Vitals tracking and external service integration (Sentry, DataDog)

**Current System Analysis** [Source: epic-007-user-facing-bug-reporting-system.md]:
- **Technical Excellence**: Sophisticated error tracking with 100-error in-memory storage, localStorage persistence, automated recovery
- **User Experience Gap**: "Report Issue" button shows alert only, no actual bug submission form
- **Missing Infrastructure**: No bug storage database schema, no lifecycle management, no Claude Code API access

### Architecture Integration

**Supabase Database Schema Design**:
```sql
-- Bug Reports Table
CREATE TABLE bug_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  bug_type TEXT NOT NULL CHECK (bug_type IN ('ui', 'functionality', 'performance', 'security', 'accessibility')),
  severity TEXT NOT NULL CHECK (severity IN ('low', 'medium', 'high', 'critical')),
  status TEXT NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'resolved', 'closed')),
  
  -- Technical Information
  browser_info JSONB,
  error_stack TEXT,
  user_agent TEXT,
  url TEXT,
  reproduction_steps TEXT,
  
  -- Metadata
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  assigned_to UUID,
  priority INTEGER DEFAULT 0,
  
  -- Error Tracking Integration
  error_context JSONB, -- From existing error tracking systems
  monitoring_data JSONB -- From APM monitoring integration
);

-- Bug Comments Table  
CREATE TABLE bug_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bug_report_id UUID REFERENCES bug_reports(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  comment TEXT NOT NULL,
  is_internal BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Bug Attachments Table
CREATE TABLE bug_attachments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bug_report_id UUID REFERENCES bug_reports(id) ON DELETE CASCADE,
  filename TEXT NOT NULL,
  file_path TEXT NOT NULL,
  file_size INTEGER NOT NULL,
  mime_type TEXT NOT NULL,
  uploaded_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Error Tracking Integration Interface**:
```typescript
// Integration with existing error tracking systems
interface BugReportData {
  // User-provided information
  title: string;
  description: string;
  bugType: 'ui' | 'functionality' | 'performance' | 'security' | 'accessibility';
  severity: 'low' | 'medium' | 'high' | 'critical';
  reproductionSteps?: string;
  
  // Auto-collected technical data
  errorContext?: ErrorReport[]; // From errorTracking.ts
  runtimeErrors?: RuntimeError[]; // From RuntimeErrorMonitor
  monitoringData?: APMMetrics; // From monitoring.ts
  browserInfo: BrowserInfo;
  userAgent: string;
  currentUrl: string;
  
  // File attachments
  attachments?: File[];
}

// Enhanced error context integration
interface EnhancedErrorContext {
  recentErrors: ErrorReport[]; // Last 10 errors from errorTracking.ts
  errorPatterns: DetectedPattern[]; // From advancedErrorTracking.ts
  performanceMetrics: CoreWebVitals; // From monitoring.ts
  userSession: UserSessionInfo;
  componentStack?: string; // From ErrorBoundary if applicable
}
```

### Integration with Existing Systems

**Error Tracking Enhancement** [Source: architecture/source-tree.md]:
- **ErrorTracking Integration**: Extend `src/lib/errorTracking.ts` with bug report correlation and automatic error data inclusion
- **Advanced Pattern Detection**: Leverage `src/lib/advancedErrorTracking.ts` for intelligent error context and pattern matching
- **Runtime Monitor**: Connect with `src/components/error/RuntimeErrorMonitor.tsx` for real-time error correlation
- **Error Boundary**: Enhance `src/components/error/ErrorBoundary.tsx` with direct bug reporting from error states

**Supabase Integration Patterns**:
- **Database Client**: Extend existing `src/lib/supabase.ts` with bug reporting database operations
- **Authentication**: Leverage existing Supabase auth for user identification and RLS policies
- **Real-time**: Use Supabase real-time features for bug status updates and notifications
- **Storage**: Implement secure file storage for bug attachments using Supabase Storage

**UI/UX Integration** [Source: architecture/tech-stack.md]:
- **Design System**: Follow existing Tailwind CSS patterns and Radix UI components
- **Form Management**: Use React Hook Form patterns consistent with existing forms
- **Validation**: Implement Zod validation schemas following established patterns
- **Accessibility**: Maintain existing accessibility standards and screen reader support

### File Locations and Structure

**Bug Reporting Components**:
- **New**: `src/components/bug-report/BugReportForm.tsx` - Main bug submission form component
- **New**: `src/components/bug-report/BugTypeSelector.tsx` - Bug type and severity selection interface
- **New**: `src/components/bug-report/FileAttachmentUpload.tsx` - File upload component with drag-drop
- **New**: `src/components/bug-report/BugReportModal.tsx` - Modal wrapper for bug reporting interface

**Backend Services**:
- **New**: `src/lib/bugReporting.ts` - Core bug reporting service with database operations
- **Enhanced**: `src/lib/errorTracking.ts` - Add bug report integration and correlation
- **Enhanced**: `src/lib/monitoring.ts` - Add bug report event tracking and metrics
- **New**: `src/hooks/useBugReport.ts` - React hook for bug report submission and validation

**Database and Types**:
- **New**: `src/types/bugReport.ts` - TypeScript interfaces for bug reporting system
- **New**: `supabase/migrations/20250127_create_bug_tables.sql` - Database schema migration
- **Enhanced**: `src/lib/supabase.ts` - Add bug reporting database queries and RLS policies

### Technical Requirements

**Performance Requirements**:
- **Form Response Time**: Bug report form must load and respond within 200ms
- **File Upload**: Support up to 10MB file attachments with progress indication
- **Database Operations**: Bug submission must complete within 2 seconds
- **Integration Overhead**: Minimal impact on existing error tracking performance

**Security and Privacy Requirements**:
- **Data Protection**: Implement proper RLS policies to protect user bug reports
- **File Security**: Virus scanning and file type validation for attachments
- **Sensitive Data**: Automatic sanitization of sensitive information from error stacks
- **User Privacy**: Option for anonymous bug reporting while maintaining traceability

**Accessibility and UX Requirements**:
- **WCAG Compliance**: Full accessibility compliance for bug reporting interface
- **Progressive Enhancement**: Form functionality without JavaScript for basic submission
- **Mobile Responsive**: Optimized bug reporting experience across all device sizes
- **User Feedback**: Clear confirmation and progress indication throughout submission process

### Integration Patterns

**Error Tracking Integration Pattern**:
```typescript
// Automatic error context collection
class BugReportService {
  async createBugReport(bugData: BugReportData): Promise<BugReport> {
    // Collect error context from existing systems
    const errorContext = await this.collectErrorContext();
    const monitoringData = await this.collectMonitoringData();
    
    // Enhanced bug report with technical context
    const enhancedBugData = {
      ...bugData,
      errorContext,
      monitoringData,
      browserInfo: this.collectBrowserInfo(),
      timestamp: new Date().toISOString()
    };
    
    // Store in Supabase with proper error handling
    return await this.storeBugReport(enhancedBugData);
  }
  
  private async collectErrorContext(): Promise<EnhancedErrorContext> {
    const recentErrors = errorTracker.getRecentErrors(10);
    const errorPatterns = advancedErrorTracker.getDetectedPatterns();
    const performanceMetrics = apmService.getCurrentMetrics();
    
    return {
      recentErrors,
      errorPatterns, 
      performanceMetrics,
      userSession: this.getCurrentSession()
    };
  }
}
```

**Database Integration Pattern**:
```typescript
// Supabase integration with existing patterns
export const bugReportService = {
  async submitBugReport(bugData: BugReportData): Promise<{ success: boolean; bugId?: string }> {
    try {
      const { data, error } = await supabase
        .from('bug_reports')
        .insert({
          title: bugData.title,
          description: bugData.description,
          bug_type: bugData.bugType,
          severity: bugData.severity,
          error_context: bugData.errorContext,
          monitoring_data: bugData.monitoringData,
          browser_info: bugData.browserInfo,
          user_agent: navigator.userAgent,
          url: window.location.href
        })
        .select()
        .single();
        
      if (error) throw error;
      
      // Process file attachments if any
      if (bugData.attachments?.length) {
        await this.uploadAttachments(data.id, bugData.attachments);
      }
      
      return { success: true, bugId: data.id };
    } catch (error) {
      console.error('Bug report submission failed:', error);
      return { success: false };
    }
  }
};
```

### Testing Requirements

**Integration Testing**:
- **Error Tracking Integration**: Test automatic error context collection and correlation
- **Database Operations**: Test bug report CRUD operations with proper validation
- **File Upload**: Test attachment upload with various file types and sizes
- **Form Validation**: Test comprehensive form validation and error handling

**User Experience Testing**:
- **Accessibility Testing**: Screen reader compatibility and keyboard navigation
- **Cross-browser Testing**: Form functionality across different browsers and devices  
- **Performance Testing**: Form load times and submission performance under load
- **Edge Case Testing**: Network failures, large files, and error scenarios

**Security Testing**:
- **RLS Policy Testing**: Test Row Level Security for proper data isolation
- **File Upload Security**: Test file type validation and virus scanning
- **Data Sanitization**: Test sensitive data removal from error stacks
- **Input Validation**: Test form input sanitization and SQL injection prevention

## Testing

### Testing Standards [Source: architecture/coding-standards.md]

**Test Framework**: Vitest + React Testing Library with Supabase testing utilities

**Test File Locations**:
- **New**: `src/components/bug-report/__tests__/BugReportForm.test.tsx` - Bug report form component tests
- **New**: `src/lib/__tests__/bugReporting.test.ts` - Bug reporting service tests
- **Enhanced**: `src/lib/__tests__/errorTracking.test.ts` - Enhanced error tracking integration tests
- **New**: `supabase/__tests__/bug-report-schema.test.sql` - Database schema validation tests

**Testing Patterns**:
- **Mock Supabase**: Create mock Supabase client for database operation testing
- **Error Simulation**: Test bug report creation with various error scenarios
- **File Upload Testing**: Mock file upload functionality and validation
- **Integration Testing**: Test complete bug report workflow from form to database

**Specific Testing Requirements**:
- **Form Functionality**: Test bug report form validation, submission, and error handling
- **Database Integration**: Test Supabase operations, RLS policies, and data integrity
- **Error Context**: Test automatic error data collection and integration
- **File Attachments**: Test file upload, validation, and secure storage
- **User Experience**: Test accessibility, responsiveness, and user feedback systems

**Performance Testing**:
- **Form Load Time**: Measure and validate bug report form initialization performance
- **Submission Time**: Test bug report submission performance under various conditions  
- **File Upload Performance**: Test large file upload handling and progress indication
- **Database Query Performance**: Test bug report queries and database operation efficiency

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-27 | 1.0 | Initial story creation for user bug report interface and database schema | Bob (Scrum Master) |