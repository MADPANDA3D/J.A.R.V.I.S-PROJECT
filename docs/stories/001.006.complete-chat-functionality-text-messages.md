# Story 001.006: Complete Chat Functionality - Text Messages

## Status
Approved

## Story
**As a** user,  
**I want** to send and receive text messages with the AI agent through n8n webhooks,  
**so that** I can have natural conversations that are properly stored, synchronized, and persist across sessions.

## Acceptance Criteria
1. Text messages send to n8n webhook endpoint successfully
2. AI agent responses are received and displayed in chat
3. Messages are stored in Supabase with proper schema
4. Message history persists between sessions
5. Error handling for failed message sends with retry mechanism
6. Message status indicators (sending, sent, delivered, failed)
7. Support for long messages with proper text wrapping
8. Message search functionality within chat history
9. Rate limiting protection with user feedback
10. Text messaging works reliably in both directions
11. Messages are properly persisted and retrievable
12. Error states are handled gracefully
13. Performance remains smooth with large message history
14. Integration tests pass for complete message flow
15. Tools selection dropdown accessible from chat input area
16. Selected tools included in n8n webhook payload structure
17. Tool selection state persists during chat session
18. UI displays available tools with clear on/off toggle controls
19. Tools usage data captured for analytics and future development
20. Tool selection enhances user experience without adding complexity

## Tasks / Subtasks

- [ ] **Supabase Database Schema** (AC: 3, 4, 11)
  - [ ] Create messages table in Supabase:
    - id (UUID, primary key)
    - user_id (UUID, foreign key to auth.users)
    - content (text)
    - role (enum: 'user', 'agent')
    - timestamp (timestamptz)
    - status (enum: 'sending', 'sent', 'delivered', 'failed')
    - message_type (enum: 'text', 'system', 'error')
    - metadata (jsonb for future extensibility)
  - [ ] Set up Row Level Security (RLS) policies:
    - Users can only access their own messages
    - Authenticated users can insert/read their messages
  - [ ] Create indexes for performance:
    - user_id + timestamp for message history queries
    - Full-text search index on content
  - [ ] Test database schema with sample data

- [ ] **n8n Webhook Integration** (AC: 1, 2, 9, 10)
  - [ ] Create hooks/useChat.ts custom hook:
    - Send message function with n8n webhook integration
    - Message state management (loading, error, success)
    - Rate limiting handling with exponential backoff
    - Network error detection and retry logic
  - [ ] Configure n8n webhook payload structure:
    - user_id from authenticated user
    - message content
    - timestamp (ISO string)
    - message_type: 'text'
    - session_id for conversation context
  - [ ] Implement webhook response handling:
    - Success response processing
    - Error response parsing and user feedback
    - Agent response message integration
  - [ ] Test webhook integration with actual n8n endpoint

- [ ] **Message State Management** (AC: 6, 12, 13)
  - [ ] Create contexts/ChatContext.tsx:
    - Messages array state
    - Loading states for sending/receiving
    - Error states with detailed error information
    - Message CRUD operations
  - [ ] Implement React Query integration:
    - Query for message history from Supabase
    - Mutation for sending new messages
    - Optimistic updates for immediate UI feedback
    - Cache management and invalidation
  - [ ] Add message status tracking:
    - Update status from 'sending' to 'sent' on success
    - Handle 'failed' status with retry options
    - Display appropriate indicators in UI

- [ ] **Real-time Message Synchronization** (AC: 2, 4, 10)
  - [ ] Implement Supabase real-time subscriptions:
    - Subscribe to messages table changes
    - Filter by current user_id
    - Handle INSERT events for new agent messages
    - Handle UPDATE events for status changes
  - [ ] Create message synchronization logic:
    - Merge real-time updates with local state
    - Prevent duplicate messages
    - Handle out-of-order message delivery
    - Maintain chronological message order
  - [ ] Test real-time sync across multiple browser tabs

- [ ] **Message Persistence & History** (AC: 4, 8, 11, 13)
  - [ ] Implement message history loading:
    - Paginated message queries for performance
    - Load recent messages on chat initialization
    - Infinite scroll for older message history
    - Efficient query optimization for large datasets
  - [ ] Create message search functionality:
    - Full-text search within user's message history
    - Search filters (date range, message type)
    - Highlight search results in message list
    - Search performance optimization
  - [ ] Add message persistence verification:
    - Confirm messages are saved to database
    - Handle offline message queuing for future story
    - Verify message integrity across sessions

- [ ] **Error Handling & Retry Logic** (AC: 5, 6, 12)
  - [ ] Implement comprehensive error handling:
    - Network connectivity errors
    - n8n webhook timeout/failure
    - Supabase database errors
    - Authentication/authorization errors
  - [ ] Create retry mechanism with exponential backoff:
    - Automatic retry for transient failures
    - Maximum retry attempts (3-5 attempts)
    - User-initiated manual retry option
    - Clear feedback about retry attempts
  - [ ] Add user-friendly error messages:
    - Network error: "Connection lost, retrying..."
    - Server error: "Message failed to send, tap to retry"
    - Rate limit: "Sending too fast, please wait..."
    - Generic error: Clear fallback messaging

- [ ] **Message Display Integration** (AC: 7, 13)
  - [ ] Update MessageBubble component from Story 001.004:
    - Display message status indicators
    - Handle long message text wrapping
    - Show timestamp information
    - Add retry button for failed messages
  - [ ] Enhance MessageList component:
    - Integrate with real message data
    - Handle loading states for message history
    - Display search results highlighting
    - Optimize rendering performance for large lists
  - [ ] Update ChatContainer component:
    - Connect to ChatContext for state management
    - Handle empty states and loading states
    - Integrate search functionality

- [ ] **Performance Optimization** (AC: 13, 14)
  - [ ] Implement message virtualization:
    - Use react-window for large message lists
    - Dynamic height calculation for messages
    - Scroll position preservation during updates
  - [ ] Optimize database queries:
    - Use database indexes effectively
    - Implement pagination for message history
    - Cache frequently accessed messages
  - [ ] Add performance monitoring:
    - Message send/receive timing
    - Database query performance
    - Real-time subscription efficiency
  - [ ] Test performance with realistic data volumes (1000+ messages)

- [ ] **Tools Selection Feature Implementation** (AC: 15, 16, 17, 18, 19, 20)
  - [ ] Create components/chat/ToolsSelector.tsx:
    - Dropdown/modal component accessible from chat input area
    - List of available tools with toggle switches
    - Tool descriptions and usage indicators
    - Responsive design for mobile and desktop
  - [ ] Implement tools data structure:
    - Define available tools list (web search, file analysis, code review, etc.)
    - Tool metadata (name, description, category, usage count)
    - Tool state management (selected/deselected)
    - Session persistence of tool selections
  - [ ] Enhance n8n webhook payload structure:
    - Add selected_tools array to message payload
    - Include tool preferences in user context
    - Maintain backward compatibility with existing payload
    - Document payload changes for n8n integration
  - [ ] Add tools usage analytics:
    - Track tool selection frequency
    - Log tool usage patterns per user
    - Store analytics data in Supabase for future analysis
    - Privacy-compliant data collection
  - [ ] Integrate with MessageInput component:
    - Add Tools button next to send button
    - Show selected tools count indicator
    - Handle tool selection state changes
    - Ensure smooth UX without disrupting message flow

- [ ] **Integration Testing** (AC: 14, 15, 16, 17, 18, 19, 20)
  - [ ] Create end-to-end test scenarios:
    - Complete message send/receive flow
    - Message persistence across browser refresh
    - Error handling and recovery
    - Real-time synchronization between sessions
    - Tools selection and payload integration
  - [ ] Test n8n webhook integration:
    - Mock n8n responses for consistent testing
    - Test various response scenarios (success, error, timeout)
    - Verify payload format and data integrity
    - Test enhanced payload with tools selection
  - [ ] Test Supabase integration:
    - Database operations (create, read, update)
    - Real-time subscription functionality
    - RLS policy enforcement
    - Performance under load
    - Tools analytics data storage
  - [ ] Test Tools Selection feature:
    - Tool selection UI functionality
    - Session persistence of selections
    - Payload enhancement verification
    - Analytics data capture
    - Cross-device synchronization

## Dev Notes

### n8n Integration Context (from Architecture Document)
- **Backend Architecture**: n8n handles all business logic for chat processing
- **Webhook Endpoints**: All frontend operations communicate via secure webhook/API endpoints
- **TTS/STT Integration**: n8n coordinates with TTS/STT APIs for future voice features
- **Business Logic**: All chat validation, processing, and response generation handled by n8n

### Message Flow Architecture (from Architecture Document)
1. User sends message via React UI
2. Frontend queues message locally, POSTs to n8n webhook
3. n8n validates/processes message, updates Supabase (chat/message row)
4. Supabase triggers real-time update to frontend; message shown in UI
5. For future: media handling will include signed URLs/preview

### Database Schema Context (from PRD Integration Points)
- **Supabase Schema**: users, chats, messages, media, tasks, automations
- **Real-time**: Real-time chat DB for messages, threads, tasks
- **Authentication**: Messages linked to authenticated users via JWT
- **Security**: Database encryption at rest, TLS for all network traffic

### Integration with Previous Stories
- **Story 001.001**: Uses established project structure and dependencies
- **Story 001.002**: Leverages Supabase client and authentication context
- **Story 001.003**: Integrates with AppLayout and routing system
- **Story 001.004**: Enhances chat UI components with real functionality

### Project Structure Context
```
src/
├── components/
│   └── chat/ (enhanced from Story 001.004)
│       ├── ToolsSelector.tsx (NEW)
│       └── MessageInput.tsx (enhanced)
├── contexts/
│   ├── ChatContext.tsx
│   └── ToolsContext.tsx (NEW)
├── hooks/
│   ├── useChat.ts
│   ├── useMessageHistory.ts
│   └── useTools.ts (NEW)
├── types/
│   ├── chat.ts (extended)
│   └── tools.ts (NEW)
└── lib/
    ├── supabase.ts (from Story 001.002)
    ├── chatApi.ts
    └── toolsApi.ts (NEW)
```

### Key Dependencies Required
```json
{
  "dependencies": {
    "@tanstack/react-query": "^5.0.0",
    "axios": "^1.6.0",
    "date-fns": "^2.30.0"
  }
}
```

### n8n Webhook Configuration (Enhanced with Tools Selection)
```typescript
// Enhanced payload structure for n8n integration
interface N8nMessagePayload {
  user_id: string;
  message: string;
  timestamp: string;
  message_type: 'text';
  session_id: string;
  selected_tools?: string[]; // NEW: User-selected tools
  metadata?: {
    user_agent: string;
    platform: string;
    tools_context?: {
      user_selections: ToolSelection[];
      session_preferences: ToolPreferences;
    };
  };
}

// Tools Selection Interface
interface ToolSelection {
  tool_id: string;
  tool_name: string;
  enabled: boolean;
  priority?: number;
}

interface ToolPreferences {
  auto_suggest: boolean;
  persist_selections: boolean;
  analytics_enabled: boolean;
}

// Expected n8n response format
interface N8nResponse {
  success: boolean;
  agent_message?: string;
  message_id?: string;
  error?: string;
}
```

### Environment Variables (from Story 001.002)
```env
VITE_SUPABASE_URL=https://[project].supabase.co
VITE_SUPABASE_ANON_KEY=[anon-key]
VITE_N8N_WEBHOOK_URL=https://[n8n-instance]/webhook/chat/send
```

### Supabase Database Schema
```sql
-- Messages table
CREATE TABLE messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  role TEXT CHECK (role IN ('user', 'agent')) NOT NULL,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  status TEXT CHECK (status IN ('sending', 'sent', 'delivered', 'failed')) DEFAULT 'sent',
  message_type TEXT CHECK (message_type IN ('text', 'system', 'error')) DEFAULT 'text',
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS Policies
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own messages" ON messages
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own messages" ON messages
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Indexes for performance
CREATE INDEX idx_messages_user_timestamp ON messages(user_id, timestamp DESC);
CREATE INDEX idx_messages_search ON messages USING GIN (to_tsvector('english', content));

-- Tools Analytics Table (NEW)
CREATE TABLE tools_usage (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  tool_id TEXT NOT NULL,
  tool_name TEXT NOT NULL,
  session_id TEXT NOT NULL,
  usage_count INTEGER DEFAULT 1,
  last_used TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS for tools_usage
ALTER TABLE tools_usage ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own tool usage" ON tools_usage
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own tool usage" ON tools_usage
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Index for tools analytics
CREATE INDEX idx_tools_usage_user_tool ON tools_usage(user_id, tool_id);
```

### Tools Configuration (NEW Feature)
```typescript
// Available Tools Configuration
interface AvailableTool {
  id: string;
  name: string;
  description: string;
  category: 'research' | 'analysis' | 'productivity' | 'creative' | 'technical';
  icon: string;
  default_enabled: boolean;
  usage_count: number;
}

// Example tools configuration
const AVAILABLE_TOOLS: AvailableTool[] = [
  {
    id: 'web_search',
    name: 'Web Search',
    description: 'Search the internet for current information',
    category: 'research',
    icon: 'search',
    default_enabled: false,
    usage_count: 0
  },
  {
    id: 'file_analysis',
    name: 'File Analysis',
    description: 'Analyze uploaded documents and files',
    category: 'analysis',
    icon: 'file-text',
    default_enabled: true,
    usage_count: 0
  },
  {
    id: 'code_review',
    name: 'Code Review',
    description: 'Review and analyze code for improvements',
    category: 'technical',
    icon: 'code',
    default_enabled: false,
    usage_count: 0
  }
  // Additional tools will be loaded from n8n workflow configuration
];
```

### Tools Usage Analytics Strategy
- **Data Collection**: Track tool selection frequency and usage patterns
- **Privacy Compliance**: Anonymized usage data with user consent
- **Business Intelligence**: Identify most popular tools for prioritized development
- **User Personalization**: Learn user preferences for smart tool suggestions
- **Performance Optimization**: Monitor tool impact on response times

### Performance Targets (from PRD)
- **Message Send Time**: <100ms under normal conditions (including tools payload)
- **Message History Load**: <500ms for typical queries
- **Real-time Latency**: <200ms for message delivery
- **Search Performance**: <300ms for message search queries
- **Tools Selection**: <50ms for tools dropdown opening and selection
- **Analytics Recording**: <10ms for usage data capture

### Error Handling Strategy
- **Network Errors**: Retry with exponential backoff (1s, 2s, 4s intervals)
- **Rate Limiting**: Display user feedback, prevent rapid successive sends
- **Server Errors**: Show retry option with clear error messaging
- **Validation Errors**: Immediate client-side feedback

### Testing Standards (Enhanced with Tools Feature)
- **Test Location**: `src/hooks/__tests__/`, `src/contexts/__tests__/`, `src/components/chat/__tests__/`
- **Test Framework**: Jest + React Testing Library + MSW for API mocking
- **Coverage Requirements**:
  - Message sending/receiving flows
  - Error handling scenarios
  - Real-time synchronization
  - Database operations
  - Performance with large datasets
  - Tools selection functionality
  - Analytics data capture
  - Enhanced payload structure
- **Test Files**:
  - `useChat.test.ts` - Chat hook functionality (enhanced with tools)
  - `ChatContext.test.tsx` - Context state management
  - `chatApi.test.ts` - API integration (enhanced payload)
  - `messageSync.test.ts` - Real-time synchronization
  - `useTools.test.ts` - Tools selection hook (NEW)
  - `ToolsContext.test.tsx` - Tools state management (NEW)
  - `ToolsSelector.test.tsx` - Tools UI component (NEW)
  - `toolsApi.test.ts` - Tools analytics API (NEW)
- **Mock Strategy**: Mock n8n webhooks, Supabase operations, and tools data

### Security Considerations
- **Input Validation**: Sanitize message content before sending/storing
- **Rate Limiting**: Prevent spam and abuse with client-side throttling
- **Authentication**: Ensure all message operations require valid JWT
- **Data Privacy**: Messages are private to authenticated user via RLS

### Real-time Architecture
- **Supabase Channels**: Subscribe to `messages` table changes filtered by user_id
- **Connection Management**: Handle connection drops and reconnection
- **Message Ordering**: Ensure chronological order despite network timing
- **Conflict Resolution**: Handle simultaneous message sending scenarios

### Integration Preparation for Future Stories
- **Media Messages**: Database schema supports future media message types
- **Voice Integration**: Framework ready for voice message transcription
- **Offline Mode**: Foundation for message queuing and sync
- **Search Enhancement**: Full-text search ready for advanced filtering

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-24 | 1.0 | Initial story draft created | Scrum Master (Bob) |
| 2025-01-24 | 1.1 | Enhanced with Tools Selection feature per Product Owner requirements | Product Owner (Sarah) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References  
*References to any debug logs generated during development*

### Completion Notes List
*Notes about task completion and any issues encountered*

### File List
*List of all files created, modified, or affected during implementation*

## QA Results
*Results from QA Agent review of completed story implementation*