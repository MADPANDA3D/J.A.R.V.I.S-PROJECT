name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      NODE_VERSION: '20'
      WORKING_DIRECTORY: 'jarvis-chat'
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './jarvis-chat/package-lock.json'

      # Set working directory for all subsequent steps
      - name: ğŸ“‹ Display build environment
        working-directory: ./jarvis-chat
        run: |
          echo "ğŸ” Build Environment Information:"
          echo "Node.js version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Working directory: ${{ env.WORKING_DIRECTORY }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"

      - name: ğŸ“¦ Install dependencies
        working-directory: ./jarvis-chat
        run: |
          echo "ğŸ“¦ Installing dependencies with npm ci..."
          npm ci --production=false
          echo "âœ… Dependencies installed successfully"
        
      - name: ğŸ” Validate environment
        working-directory: ./jarvis-chat
        run: |
          echo "ğŸ” Validating project configuration..."
          
          # Check package.json exists and has required scripts
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found"
            exit 1
          fi
          
          # Verify required scripts exist
          if ! npm run --silent 2>/dev/null | grep -q "test\|build\|lint"; then
            echo "âš ï¸ Some required scripts may be missing"
          fi
          
          # Check critical files exist
          if [ ! -f "vite.config.ts" ]; then
            echo "âš ï¸ vite.config.ts not found - build may fail"
          fi
          
          if [ ! -f "tsconfig.json" ]; then
            echo "âš ï¸ tsconfig.json not found - TypeScript compilation may fail"
          fi
          
          echo "âœ… Environment validation completed"

      - name: ğŸ§ª Run tests
        working-directory: ./jarvis-chat
        run: |
          echo "ğŸ§ª Running test suite..."
          
          # Run tests with proper error handling
          if npm run test:run; then
            echo "âœ… All tests passed successfully"
          else
            echo "âŒ Tests failed"
            
            # Check if force deploy is enabled
            if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
              echo "âš ï¸ Force deploy enabled - continuing despite test failures"
            else
              echo "ğŸ›‘ Deployment cancelled due to test failures"
              exit 1
            fi
          fi

      - name: ğŸ”§ Run linting
        working-directory: ./jarvis-chat
        run: |
          echo "ğŸ”§ Running code linting..."
          
          if npm run lint; then
            echo "âœ… Linting passed successfully"
          else
            echo "âš ï¸ Linting issues found - continuing with deployment"
            echo "Note: Fix linting issues in future commits"
          fi

      - name: ğŸ“Š Type checking
        working-directory: ./jarvis-chat
        run: |
          echo "ğŸ“Š Running TypeScript type checking..."
          
          if npm run type-check; then
            echo "âœ… Type checking passed successfully"
          else
            echo "âŒ Type checking failed"
            
            # Check if force deploy is enabled
            if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
              echo "âš ï¸ Force deploy enabled - continuing despite type errors"
            else
              echo "ğŸ›‘ Deployment cancelled due to type errors"
              exit 1
            fi
          fi

      - name: ğŸ—ï¸ Build application
        working-directory: ./jarvis-chat
        run: |
          echo "ğŸ—ï¸ Building application for production..."
          
          # Set build environment
          export NODE_ENV=production
          
          if npm run build; then
            echo "âœ… Build completed successfully"
            
            # Display build info
            if [ -d "dist" ]; then
              echo "ğŸ“Š Build artifacts:"
              ls -la dist/
              du -sh dist/
            fi
          else
            echo "âŒ Build failed"
            exit 1
          fi

      - name: ğŸ” Validate build artifacts
        working-directory: ./jarvis-chat
        run: |
          echo "ğŸ” Validating build artifacts..."
          
          if [ ! -d "dist" ]; then
            echo "âŒ Build directory 'dist' not found"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Main index.html not found in build"
            exit 1
          fi
          
          # Check for critical assets
          if ls dist/assets/*.js 1> /dev/null 2>&1; then
            echo "âœ… JavaScript assets found"
          else
            echo "âš ï¸ No JavaScript assets found"
          fi
          
          if ls dist/assets/*.css 1> /dev/null 2>&1; then
            echo "âœ… CSS assets found"
          else
            echo "âš ï¸ No CSS assets found"
          fi
          
          echo "âœ… Build artifacts validation completed"

      - name: ğŸ“¤ Prepare deployment metadata
        run: |
          echo "ğŸ“¤ Preparing deployment metadata..."
          
          # Create deployment metadata
          cat > deployment-metadata.json << EOF
          {
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "author": "${{ github.event.head_commit.author.name }}",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "build_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "node_version": "${{ env.NODE_VERSION }}",
            "environment": "production"
          }
          EOF
          
          echo "âœ… Deployment metadata prepared:"
          cat deployment-metadata.json

      - name: ğŸš€ Deployment successful
        run: |
          echo "ğŸ‰ Build completed successfully!"
          echo ""
          echo "ğŸ“‹ Deployment Summary:"
          echo "  â€¢ Repository: ${{ github.repository }}"
          echo "  â€¢ Branch: ${{ github.ref_name }}"
          echo "  â€¢ Commit: ${{ github.sha }}"
          echo "  â€¢ Build ID: ${{ github.run_id }}"
          echo "  â€¢ Node.js: ${{ env.NODE_VERSION }}"
          echo "  â€¢ Status: âœ… READY FOR DEPLOYMENT"
          echo ""
          echo "ğŸ”— Webhook will trigger VPS deployment automatically"
          echo "ğŸ¯ VPS webhook server will process this workflow_run event"
          echo "ğŸ“¡ Check VPS logs at: http://69.62.71.229:9000/dashboard"

      - name: ğŸ“Š Workflow completion notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… WORKFLOW COMPLETED SUCCESSFULLY"
            echo "ğŸš€ VPS deployment will be triggered automatically via webhook"
          else
            echo "âŒ WORKFLOW FAILED"
            echo "ğŸ›‘ No deployment will be triggered"
          fi
          
          echo ""
          echo "ğŸ“‹ Final Status: ${{ job.status }}"
          echo "ğŸ• Completed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
